# 小市值策略回测系统（Backtrader + MLflow）

## 📘 项目简介

本项目基于 Backtrader 实现一个小市值量化策略，具备如下特性：

* 精选财务健康、低市值个股
* 动态调仓逻辑：每周二上午10点自动调仓
* 多因子止损保护：趋势熔断 + 动量监控
* 支持 MLflow 自动记录实验结果
* 包含完整数据加载、策略逻辑、图表展示、评估指标

---

## ⚙️ 使用说明

### 📁 项目结构

```text
.
├── config.yaml              # 策略参数配置
├── run_backtest.py         # 主运行脚本（含 MLflow 记录）
├── strategies/
│   └── smallcap_strategy.py  # 小市值策略主类
├── utils/
│   ├── data_loader.py       # 自定义数据加载模块
│   └── metrics.py           # 策略评估指标与图表
├── data/
│   └── *.csv                # 股票 & 指数 历史数据文件
└── mlruns/                  # MLflow 实验记录目录（运行后生成）
```

### 🛠️ 安装依赖

```bash
pip install backtrader pandas matplotlib mlflow
```

---

## 📁 数据格式要求（CSV）

所有数据以日频 CSV 格式保存，字段如下：

| 字段       | 含义                  |
| -------- | ------------------- |
| datetime | 日期，格式为 `YYYY-MM-DD` |
| open     | 开盘价                 |
| high     | 最高价                 |
| low      | 最低价                 |
| close    | 收盘价                 |
| volume   | 成交量                 |
| mv       | 市值（float）           |
| profit   | 净利润（float）          |
| revenue  | 营业收入（float）         |
| is\_st   | 是否ST（0/1）           |

指数数据（如中证2000、沪深300、红利ETF、上证50）也需包含相同字段。

---

## 📌 策略逻辑概览

### ✅ 选股条件

* 市值 > 10 亿
* 净利润 > 0
* 营收 > 1 亿
* 非 ST 股

### 🔄 调仓规则

* 每周二上午10点调仓
* 当前持仓中市值变大者将被剔除
* 行情好：持股集中（5只）
* 行情差：持股分散（10只）

### 🛡️ 止损机制

1. **趋势熔断机制**：小市值指数单日跌幅 > 5% → 即时清仓，最多清仓1周
2. **动量机制**：若小市值指数动量不再领先沪深300/红利ETF/上证50 → 清仓观察

---

## 🚀 快速运行

```bash
python run_backtest.py \
  --config config.yaml \
  --data_dir ./data \
  --mlflow_uri ./mlruns
```

运行后将自动：

* 加载配置与数据
* 执行策略回测
* 保存净值图至本地
* 记录指标 & 图表至 MLflow 实验平台

---

## 📈 指标与图表

* 净值曲线图
* 总收益率、年化收益率、夏普比率、最大回撤等指标
* 可选扩展：持仓变动图、指数对比图等

---

## 📬 联系与扩展建议

* 支持加入更多市场风格判断因子（如波动率、资金流向）
* 支持引入风险因子中性化处理
* 欢迎在 issues 中留言或提交 PR ❤️
